<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Basic Metas -->
	<meta charset="utf-8">
	<title>А давай бабахнем? | qa7.ru</title>
	<meta name="description" content="Всем привет, я опять на связи. На днях возникла необходимость провести нагрузочное тестирование и встал вопрос освежить свои знания в нагрузочном тестировании. В процессе наткнулся на давно известный мне, но который так и не получилось потрогать и пощупать инструмент от яндекса под названием яндекс.Танк (хотя в итоге я все ...">
	<meta name="author" content="Erik Khalimov">
	<link rel="author" href="https://plus.google.com/+ErikKhalimov"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<!-- Twitter Cards and Open Graph -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:creator" content="@biomehanik">
	<meta name="twitter:domain" content="">
	<meta name="twitter:site" content="@biomehanik">
	<meta property="og:title" content="А давай бабахнем?">
	<meta property="og:description" content="Всем привет, я опять на связи. На днях возникла необходимость провести нагрузочное тестирование и встал вопрос освежить свои знания в нагрузочном тестировании. В процессе наткнулся на давно известный мне, но который так и не получилось потрогать и пощупать инструмент от яндекса под названием яндекс.Танк (хотя в итоге я все ...">
	<meta property="og:image" content="http://qa7.ru/theme/images/avatar512.png">
	<meta property="og:type" content="article">
	<meta property="og:url" content="http://qa7.ru/blog/2017/03/17/a-davai-babakhnem/">

	<!-- Stylesheets and Web Fonts -->
	<link href="/theme/style.min.css" rel="stylesheet">
	<link href="//fonts.googleapis.com/css?family=Raleway:400,600|Source+Code+Pro" rel="stylesheet" type="text/css">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Favicons -->
	<link rel="apple-touch-icon" href="/theme/images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="57x57" href="/theme/images/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/theme/images/apple-touch-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/theme/images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/theme/images/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/theme/images/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/theme/images/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/theme/images/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/theme/images/apple-touch-icon-152x152.png">

	<link rel="icon" type="image/png" href="/theme/images/favicon-16x16.png" sizes="16x16">
	<link rel="icon" type="image/png" href="/theme/images/favicon-32x32.png" sizes="32x32">
	<link rel="icon" type="image/png" href="/theme/images/favicon-96x96.png" sizes="96x96">
	<link rel="icon" type="image/png" href="/theme/images/favicon-160x160.png" sizes="160x160">
	<link rel="icon" type="image/png" href="/theme/images/favicon-196x196.png" sizes="196x196">

	<meta name="application-name" content="qa7.ru">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="msapplication-TileImage" content="theme/images/mstile-144x144.png">
	<meta name="msapplication-square70x70logo" content="theme/images/mstile-small.png">
	<meta name="msapplication-square150x150logo" content="theme/images/mstile-medium.png">
	<meta name="msapplication-wide310x150logo" content="theme/images/mstile-wide.png">
	<meta name="msapplication-square310x310logo" content="theme/images/mstile-large.png">

	<!--[if lt IE 9]>
	<script src="/theme/js/html5shiv.min.js"></script>
	<script src="/theme/js/respond.min.js"></script>
	<![endif]-->
</head>

<body>
	<div class="container">
		<aside id="sidebar" class="side-column">
			<a href="/"><img id="avatar" alt="Site Avatar" src="/theme/images/avatar.png"></a>
			<div id="logo" class="text-center"><a href="/">qa7.ru</a></div>
			<div id="bio" class="text-center">Blog about programming, testing and life</div>

			<div id="sidebar-links" class="text-center">
				<a href="/about/">About</a>&ensp;&bull;&ensp;<a href="/projects/">Projects</a>
			</div>

			<div id="social" class="text-center">
				<a href="mailto:biomaks@gmail.com" title="Email" class="icon fa fa-envelope"></a>
				<a href="http://twitter.com/biomehanik" title="Twitter" class="icon fa fa-twitter"></a>
				<a href="http://plus.google.com/+ErikKhalimov" title="Google+" class="icon fa fa-google-plus-square"></a>
				<a href="http://github.com/biomaks" title="GitHub" class="icon fa fa-github"></a>
				<a href="atom.xml" title="RSS" class="icon fa fa-rss"></a>
			</div>

			<hr id="sidebar-divider">
			<a id="st" href="http://software-testing.ru/about/blogs" target="_blank"><img src="http://software-testing.ru/images/stru_blog_banner.gif" border="0" width="88" height="60" alt="Software-Testing.Ru" /></a>
		</aside>

		<article class="main-column">
	<h1 class="title"><a href="/blog/2017/03/17/a-davai-babakhnem/" title="Permalink to А давай бабахнем?">А давай бабахнем?</a></h1>
	<time class="date" datetime="2017-03-17 20:42:01+03:00">March 17, 2017</time>
	<div class="content">
		<p>Всем привет, я опять на связи. 
На днях возникла необходимость провести нагрузочное тестирование и встал вопрос освежить свои знания в нагрузочном тестировании. В процессе наткнулся на давно известный мне, но который так и не получилось потрогать и пощупать инструмент от яндекса под названием яндекс.Танк (хотя в итоге я все равно взял для своих целей jmeter =) ). Так что давайте потрогаем его вместе. </p>
<blockquote>
<p><em><strong>жахать</strong> прост. о пушках, минометах и т.д; издать сильный низкий звук при выстреле ◆ Жахнуло, обдало лейтенанта снегом и пламенем, ударило комками земли в лицо, забило рот, катануло по траншее, словно зайчонка. В. П. Астафьев</em> </p>
</blockquote>
<p>Живет и разрабатывается он тут: <a href="https://github.com/yandex/yandex-tank">https://github.com/yandex/yandex-tank</a> Ни шатко ни валко, кто нибудь да пульнет в него раз в две недели коммит. Собственно что это такое? Сиё есть питонячая обертка над несколькими генераторами нагрузки, которая позволяет вполне себе удобно всадить по самые …  нагрузить какой нибудь сервер, до тех пор пока ему не поплохеет, либо не подавится, что позволит нам узнать основные его параметры производительности. Из коробки поддерживаются следующие генераторы нагрузки (сам танк очевидно ничего не нагружает, он всего лишь говорит кому, что и чем нагружать): <code>phantom</code>, <code>JMeter</code>, <code>BFG</code>, и неведомая мне хрень под названием <code>pandora</code>.<br/>
Phantom это нечто, судя по всему разрабатываемое кем-то из яндекса, способное генерировать нагрузку и используемое танком по умолчанию. Старый добрый <code>JMeter</code> знают все, чтобы воспользоваться им в танке, необходимо подготовить <code>.jmx</code> с тест планом и подключить нужный плагин. С другими двумя генераторами еще не разобрался. </p>
<p>Установка несложная, но сам по себе танк похоже работает только на дебианоподобных системах, типа ubuntu, поэтому если вы не можете себя назавать убунтоводом или же психиатр не поставил вам диагноз ubuntu головного мозга, то стоит воспользоваться докер контейнером, любезно предоставленным нам разработчиками танка. </p>
<blockquote>
<p>Может бабахнем? Обязательно бабахнем. И не раз. Весь мир в труху! Но потом.</p>
</blockquote>
<p>Прежде чем стрелять, надо сначала понять чем, куда, и как. Мы не будем сейчас вдаваться в тонкости профиля нагрузки, типов нагрузки, какие у нас требования к производительности и т.д. Мы просто хотим жахнуть, да посильнее. И это то, что танк умеет! Давайте представим что у нас есть сервер, который мы хотим протестировать, и он крутиться по адресу: 192.168.1.100 на порту 8989. И пульнуть в него мы хотим тысячью HTTP реквестов в течении одной минуты. Что нам для этого надо? Очевидно нам нужно как-то сказать танку что мы от него хотим, поэтому мы создаем конфигурацию нагрузки. По умолчанию танк для этих целей ищет и потом использует файл load.ini поэтому создаем его со следующим содержимым:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span class="k">[phantom]</span>
<span class="na">address</span><span class="o">=</span><span class="s">192.168.1.100</span>
<span class="na">port</span><span class="o">=</span><span class="s">8989</span>
<span class="na">rps_schedule</span><span class="o">=</span><span class="s">const(1000, 60s)</span>
</pre></div>
</td></tr></table>
<p>Все на первый взгляд очевидно, но для самых продвинутых подсказываю: <code>[phantom]</code> это название секции которую он же и будет использовать для нагрузки. <code>address</code> это собственно адрес, а <code>port</code> собственно порт. А вот с rps_schedule поинтересней  будет, нигде в документации не сказано, что это и зачем, поэтому методом дедукции предполагаем что это некое расписание нагрузки… на самом деле это ключевой параметр который задает профиль нагрузки. Он может быть следующих видов:</p>
<ul>
<li><code>сonst(1, 20s)</code> постоянная нагрузка в 1 rps в течении 20 сек</li>
<li><code>line(1, 100, 10m)</code> линейная нагрузка с 1 rps до 100 rps, в течении 10 минут</li>
<li><code>step(5, 100, 5, 60)</code> пошаговая нагрузка с 5 rps до 100 rps c шагом 5 rps в течении 60 секунд</li>
</ul>
<p>Далее… Дальше нам  нужно понять что конкретно нужно делать. Дёргать один URI или несколько?  Какие заголовки использовать? Какие куки? </p>
<p>Слышу стук. Это нетерпеливый читатель, бьет копытом и вопрошает: ну когда же жахнем?! 
Скоро.. Осталось совсем немного.</p>
<p>Добавляем в <code>load.ini</code> заголовки и uri по которым будем стрелять:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span class="k">[phantom]</span>
<span class="na">address</span><span class="o">=</span><span class="s">192.168.1.100</span>
<span class="na">port</span><span class="o">=</span><span class="s">8989</span>
<span class="na">rps_schedule</span><span class="o">=</span><span class="s">const(1000, 60s)</span>

<span class="na">headers</span> <span class="o">=</span> <span class="s">[Host: www.target.com]</span>
<span class="s">  [Connection: close]</span>

<span class="na">uris</span> <span class="o">=</span> <span class="s">/</span>
<span class="s">  /test</span>
<span class="s">  /test?param=10</span>
<span class="s">  /test/path/resource</span>
</pre></div>
</td></tr></table>
<p>Ну вот теперь все, можно жахать.
А жахнем мы выполнив команду находясь в той же директории, что и наш файл <code>load.ini</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span class="x">docker run -v </span><span class="p">$(</span><span class="err">pwd</span><span class="p">)</span><span class="x">:/var/loadtest -v </span><span class="p">$</span><span class="nv">HOME</span><span class="x">/.ssh:/root/.ssh --net host -it direvius/yandex-tank --name tank</span>
</pre></div>
</td></tr></table>
<p>Расшифровывать что эта строка значит, не буду, не маленькие. Сразу после скачивания и запуска контейенера пойдет нагрузка. Должна по крайней мере.</p>
<p>Вот собственно и жахнули. Не впечатлило? А все потому, что мы и не поняли, что произошло. А чтобы понять подключим мы еще пару фич. Для этого выполним еще пару телодвижений:</p>
<p>Для начала заходим на https://overload.yandex.net/ авторизовываемся и получаем  свой api token.
Сохраняем его в файл <code>token.txt</code>.</p>
<p>Добавляем еще несколько строк в файл <code>load.ini</code></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="codehilite"><pre><span class="k">[phantom]</span>
<span class="na">address</span><span class="o">=</span><span class="s">192.168.1.100</span>
<span class="na">port</span><span class="o">=</span><span class="s">8989</span>
<span class="na">rps_schedule</span><span class="o">=</span><span class="s">const(1000, 60s)</span>

<span class="na">headers</span> <span class="o">=</span> <span class="s">[Host: www.target.com]</span>
<span class="s">  [Connection: close]</span>

<span class="na">uris</span> <span class="o">=</span> <span class="s">/</span>
<span class="s">  /test</span>
<span class="s">  /test?param=10</span>
<span class="s">  /test/path/resource</span>

<span class="k">[overload]</span>
<span class="na">token_file</span><span class="o">=</span><span class="s">token.txt</span>

<span class="k">[tank]</span>
<span class="na">plugin_overload</span><span class="o">=</span><span class="s">yandextank.plugins.Overload</span>
</pre></div>
</td></tr></table>
<p>Сохраняем и жахаем еще раз:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre>docker start tank
</pre></div>
</td></tr></table>
<p>затем смотрим в логи танка и ищем строку вида: <code>Web link: https://overload.yandex.net/XXXX</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre>docker logs tank
</pre></div>
</td></tr></table>
<p>Проходим по ссылке и наслаждаемся графиками, и сразу становиться ясно, что не зря столько старались.</p>
<p>Всем спасибо, на сегодня все.</p>
<p>PS</p>
<p>В ходе данной пристрелки, ни одного программиста не пострадало.</p>
	</div>

	<div id="related-articles">
		<a href="/blog/2017/04/02/likbez-po-jmeter/" id="next-neighbour">&laquo; Ликбез по "JMeter"</a>
		<a href="/blog/2016/08/15/selenide-post/" id="prev-neighbour">Selenide пост &raquo;</a>
	</div>

	<hr>

	<!-- Disqus -->
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		var disqus_shortname = 'biomaks-github-io';
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
			<hr>
		</article>

		<footer class="main-column">
			<p>Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://pages.github.com">GitHub&nbsp;Pages</a>.</p>
		</footer>
	</div>

	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-46878829-1', '');
		ga('send', 'pageview');
	</script>

	<!-- Yandex.Metrika counter -->
	<script type="text/javascript">
	(function (d, w, c) {
	    (w[c] = w[c] || []).push(function() {
	        try {
	            w.yaCounter23571979 = new Ya.Metrika({id:23571979,
	                    webvisor:true,
	                    clickmap:true,
	                    trackLinks:true,
	                    accurateTrackBounce:true});
	        } catch(e) { }
	    });

	    var n = d.getElementsByTagName("script")[0],
	        s = d.createElement("script"),
	        f = function () { n.parentNode.insertBefore(s, n); };
	    s.type = "text/javascript";
	    s.async = true;
	    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

	    if (w.opera == "[object Opera]") {
	        d.addEventListener("DOMContentLoaded", f, false);
	    } else { f(); }
	})(document, window, "yandex_metrika_callbacks");
	</script>
	<noscript><div><img src="//mc.yandex.ru/watch/23571979" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
	<!-- /Yandex.Metrika counter -->
</body>
</html>