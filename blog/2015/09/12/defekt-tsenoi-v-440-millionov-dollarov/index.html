<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Basic Metas -->
	<meta charset="utf-8">
	<title>Дефект ценой в 440 миллионов долларов | qa7.ru</title>
	<meta name="description" content="Вы никогда не задумывались к каким серьезным последствиям могут привести ошибки? Какова цена старого и не поддерживаемого кода? Сколько стоит не протестировать устаревшую и казалось бы ненужную функциональность? И сколько раз мы слышали, что этот код никогда не вызовется потому что ....? Это грустная история взаимодействия IT профессионалов, разработчиков, администраторов и ...">
	<meta name="author" content="Erik Khalimov">
	<link rel="author" href="https://plus.google.com/+ErikKhalimov"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<!-- Twitter Cards and Open Graph -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:creator" content="@biomehanik">
	<meta name="twitter:domain" content="">
	<meta name="twitter:site" content="@biomehanik">
	<meta property="og:title" content="Дефект ценой в 440 миллионов долларов">
	<meta property="og:description" content="Вы никогда не задумывались к каким серьезным последствиям могут привести ошибки? Какова цена старого и не поддерживаемого кода? Сколько стоит не протестировать устаревшую и казалось бы ненужную функциональность? И сколько раз мы слышали, что этот код никогда не вызовется потому что ....? Это грустная история взаимодействия IT профессионалов, разработчиков, администраторов и ...">
	<meta property="og:image" content="http://qa7.ru/theme/images/avatar512.png">
	<meta property="og:type" content="article">
	<meta property="og:url" content="http://qa7.ru/blog/2015/09/12/defekt-tsenoi-v-440-millionov-dollarov/">

	<!-- Stylesheets and Web Fonts -->
	<link href="/theme/style.min.css" rel="stylesheet">
	<link href="//fonts.googleapis.com/css?family=Raleway:400,600|Source+Code+Pro" rel="stylesheet" type="text/css">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Favicons -->
	<link rel="apple-touch-icon" href="/theme/images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="57x57" href="/theme/images/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/theme/images/apple-touch-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/theme/images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/theme/images/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/theme/images/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/theme/images/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/theme/images/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/theme/images/apple-touch-icon-152x152.png">

	<link rel="icon" type="image/png" href="/theme/images/favicon-16x16.png" sizes="16x16">
	<link rel="icon" type="image/png" href="/theme/images/favicon-32x32.png" sizes="32x32">
	<link rel="icon" type="image/png" href="/theme/images/favicon-96x96.png" sizes="96x96">
	<link rel="icon" type="image/png" href="/theme/images/favicon-160x160.png" sizes="160x160">
	<link rel="icon" type="image/png" href="/theme/images/favicon-196x196.png" sizes="196x196">

	<meta name="application-name" content="qa7.ru">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="msapplication-TileImage" content="theme/images/mstile-144x144.png">
	<meta name="msapplication-square70x70logo" content="theme/images/mstile-small.png">
	<meta name="msapplication-square150x150logo" content="theme/images/mstile-medium.png">
	<meta name="msapplication-wide310x150logo" content="theme/images/mstile-wide.png">
	<meta name="msapplication-square310x310logo" content="theme/images/mstile-large.png">

	<!--[if lt IE 9]>
	<script src="/theme/js/html5shiv.min.js"></script>
	<script src="/theme/js/respond.min.js"></script>
	<![endif]-->
</head>

<body>
	<div class="container">
		<aside id="sidebar" class="side-column">
			<a href="/"><img id="avatar" alt="Site Avatar" src="/theme/images/avatar.png"></a>
			<div id="logo" class="text-center"><a href="/">qa7.ru</a></div>
			<div id="bio" class="text-center">Blog about programming, testing and life</div>

			<div id="sidebar-links" class="text-center">
				<a href="/about/">About</a>&ensp;&bull;&ensp;<a href="/projects/">Projects</a>
			</div>

			<div id="social" class="text-center">
				<a href="mailto:biomaks@gmail.com" title="Email" class="icon fa fa-envelope"></a>
				<a href="http://twitter.com/biomehanik" title="Twitter" class="icon fa fa-twitter"></a>
				<a href="http://plus.google.com/+ErikKhalimov" title="Google+" class="icon fa fa-google-plus-square"></a>
				<a href="http://github.com/biomaks" title="GitHub" class="icon fa fa-github"></a>
				<a href="atom.xml" title="RSS" class="icon fa fa-rss"></a>
			</div>

			<hr id="sidebar-divider">
			<a id="st" href="http://software-testing.ru/about/blogs" target="_blank"><img src="http://software-testing.ru/images/stru_blog_banner.gif" border="0" width="88" height="60" alt="Software-Testing.Ru" /></a>
		</aside>

		<article class="main-column">
	<h1 class="title"><a href="/blog/2015/09/12/defekt-tsenoi-v-440-millionov-dollarov/" title="Permalink to Дефект ценой в 440 миллионов долларов">Дефект ценой в 440 миллионов долларов</a></h1>
	<time class="date" datetime="2015-09-12 15:44:29+03:00">September 12, 2015</time>
	<div class="content">
		<p>Вы никогда не задумывались к каким серьезным последствиям могут привести ошибки? Какова цена старого и не поддерживаемого кода? Сколько стоит не протестировать устаревшую и казалось бы ненужную функциональность? И сколько раз мы слышали, что этот код никогда не вызовется потому что ....? Это грустная история взаимодействия IT профессионалов, разработчиков, администраторов и тестировщиков. </p>
<h2>Предыстория</h2>
<p><a href="https://en.wikipedia.org/wiki/Knight_Capital_Group">Knight Capital Group</a> (далее KCG) - американская глобальная финансовая компания, оперирующая на рынке финансовых услуг. В 2012 году Knight Capital Group был крупнейшим игроком на рынке электронной высокочастотной торговли, с долей рынка 17.3% NYSE, и 16.9% NASDAQ на тот момент. Объем торговли превышал в среднем <strong>21 млрд долларов ежедневно!!</strong></p>
<p><a href="https://ru.wikipedia.org/wiki/%D0%9D%D1%8C%D1%8E-%D0%99%D0%BE%D1%80%D0%BA%D1%81%D0%BA%D0%B0%D1%8F_%D1%84%D0%BE%D0%BD%D0%B4%D0%BE%D0%B2%D0%B0%D1%8F_%D0%B1%D0%B8%D1%80%D0%B6%D0%B0">NYSE</a> - в тот период времени планировала к запуску 1 августа 2012 года, новую программу ликвидности (Retail Liquidity Program - в дальнейшем RLP), эта программа предлагала продвинутую оценку розничным инвесторам работающим через брокеров, таких как Knight Capital Group(KCG). Для подготовки к этому событию KCG обновила свои автоматические алгоритмические маршрутизаторы высокочастотной торговли известных как SMARS. Одной из ключевых особенностей SMARS - это получение заявок от других компонентов торговой платформы Knight ("родительских"" заявок), и, по мере необходимости на основе имеющейся ликвидности, отправка одного или нескольких представительских (или "дочерних") заявок внешним службам на исполнение. Другими словами SMARS получал "большую" заявку, разбивал ее на мелкие части и отсылал их продавцам/покупателям на исполнение, в пределах "большой" заявки. Чем больше была заявка, на тем больше мелких частей она разбивалась. </p>
<p>При развертывании новый RLP код в SMARS должен был заменить неиспользуемый код в соответствующей части маршрутизатора. Этот неиспользуемый код ранее был нужен для функции Power Peg (эту функциональность компания не применяла 8 лет!!). Несмотря на это, она оставалась рабочей и вызываемой во время развертывания RLP. Новый RLP код использовал флаг, который ранее был привязан к Power Peg. Knight хотела удалить код Power Peg, чтобы при активации этого флага использовалась новая функциональность RLP, а не Power Peg.</p>
<h2>Что-то пошло не так</h2>
<p>В период с 27 по 31 июля 2012 года KCG в ручном режиме обновляла ограниченное количество своих серверов в день - всего 8 серверов. </p>
<blockquote>
<p>в ходе деплоемента один из специалистов KCG не залил новый код на одну из машин SMARS. Второго специалиста который бы контролировал действия первого и перепроверил работу, не было. Никто в KCG не понял, что старый код Power Peg не был удален с восьмого сервера, а код поддерживающий RPL не был добавлен. В KCG не существовал письменного регламента данной процедуры проверки. (из <a href="http://www.sec.gov/litigation/admin/2013/34-70694.pdf">отчета</a> Комиссии по ценным бумагам. | Release No. 70694 | October 16, 2013)</p>
</blockquote>
<p>В 9.30 утра 1 августа 2012 года рынки открылись и KCG начала процессить заявки своих брокеров от имени заказчиков через RPL. Семь серверов обрабатывали заявки правильно. Но заявки, отправленные на 8 сервер с установленным флагом запуска, запустили дефектный код Power Peg, который всё ещё присутствовал на этом сервере. В результате сервер воспринял заявки как родительские и начал отправлять дочерние заявки в трейдинговые центры.</p>
<h2>Атака зомби-кода</h2>
<p>Важно понимать, что делал код Power Peg. Эта функциональность помимо прочего подсчитывала купленные/проданные ценные бумаги в выполняемых дочерних заявках и сигнализировала о необходимости прекращения размещения дочерних заявках после того, как родительская заявка была выполнена (так называемый трекинг заявок). Этот трекинг заявок был в 2005 году перемещен на более раннюю стадию выполнения кода. И когда на восьмой сервер приходили заявки с флагом который предназначался для RPL, Power Peg начал их процессить, но так-как функции трекинга не было, начался так называемый бесконечный цикл купли-продажи.</p>
<blockquote>
<p>1 августа Knight также получала заявки, которые относились к RPL, но предназначались для торговли до открытия рынка. Сервера SMARS обрабатывали эти заявки и, начиная примерно с 8:01 утра, внутренние системы генерировали автоматические сообщения (под названием «отказ BNET»), которые ссылались на SMARS и описывали ошибку как «Power Peg отключен». Система Knight отправила 97 таких сообщений до 9:30 утра, когда открылся рынок. Сообщения подобного типа не расценивались системой, как опасные, а персонал вообще не читал их. (из <a href="http://www.sec.gov/litigation/admin/2013/34-70694.pdf">отчета</a> Комиссии по ценным бумагам. | Release No. 70694 | October 16, 2013)</p>
</blockquote>
<h2>45 минут ада</h2>
<p>Можете себе представить систему высокочастотной торговли ценными бумагами которая способная отсылать и исполнять тысячи заявок в минуту, функция трекинга исполнения заявок у которой отключена? Да, это было примерно так все плохо.</p>
<p>В 9.30 когда рынки открылись люди начали быстро догадываться, что что-то не так. В 9.31 для многих людей на Уолл-Стрит стало очевидно, что происходит что-то серьезное. Рынок наводнили заявки, неординарной стоимости для обычных объемов торгов на определенные ценные бумаги. В 9.32 трейдеры недоумевали почему это не заканчивается. Для высокочастотных торгов этот период времени был равноценен вечности. В течении 45 минут Knight создала более 50% всего объема торгов, повышая стоимость определенных бумаг на 10%. Как результат стоимость остальных ценных бумаг была снижена в ответ на ошибочные торги.</p>
<p>В течении 45 минут KCG пыталась оценить обстановку и остановить ошибочные торги. У KCG не было рубильника останавливающего торги, равно как и документированного регламента как действовать в случае подобной нештатной ситуации. Они пытались диагностировать проблему в живом окружении обслуживающем 8 миллионов операций каждую минуту. Так как они не понимали причину возникновения проблемных заявок, они начали откатывать изменения. Откатывать те изменения которые работали корректно. Что только усугубило положение, так как Power Peg  начал работать на всех серверах, а не на одном как ранее. В конце концов они смогли остановить работу системы через 45 минут после ее старта.</p>
<p>За те 45 минут, что рынок был открыт, Power Peg код получил и отпроцесиил 212 родительских заявок. Как результат SMARS сгенерировал 4 миллиона транзакций по 154 ценным бумагам для 397 миллионов акций. Knight приняла $3.5 миллиардов длинных позиций и $3.15 миллиарда коротких. Проще говоря, Knight спустила 450 миллионов долларов за 45 минут. За 45 минут Knight Capital Group, крупнейший игрок на рынке, стал банкротом.</p>
	</div>

	<div id="related-articles">
		<a href="/blog/2015/09/04/shveitsarskii-nozh-dlia-liubogo-testirovshchika/" id="prev-neighbour">Швейцарский нож для любого тестировщика &raquo;</a>
	</div>

	<hr>

	<!-- Disqus -->
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		var disqus_shortname = 'biomaks-github-io';
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
			<hr>
		</article>

		<footer class="main-column">
			<p>Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://pages.github.com">GitHub&nbsp;Pages</a>.</p>
		</footer>
	</div>

	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-46878829-1', '');
		ga('send', 'pageview');
	</script>

	<!-- Yandex.Metrika counter -->
	<script type="text/javascript">
	(function (d, w, c) {
	    (w[c] = w[c] || []).push(function() {
	        try {
	            w.yaCounter23571979 = new Ya.Metrika({id:23571979,
	                    webvisor:true,
	                    clickmap:true,
	                    trackLinks:true,
	                    accurateTrackBounce:true});
	        } catch(e) { }
	    });

	    var n = d.getElementsByTagName("script")[0],
	        s = d.createElement("script"),
	        f = function () { n.parentNode.insertBefore(s, n); };
	    s.type = "text/javascript";
	    s.async = true;
	    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

	    if (w.opera == "[object Opera]") {
	        d.addEventListener("DOMContentLoaded", f, false);
	    } else { f(); }
	})(document, window, "yandex_metrika_callbacks");
	</script>
	<noscript><div><img src="//mc.yandex.ru/watch/23571979" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
	<!-- /Yandex.Metrika counter -->
</body>
</html>